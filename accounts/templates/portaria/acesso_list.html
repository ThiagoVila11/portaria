{% extends "base.html" %}
{% load timezone_filters %}
{% block title %}Acessos ¬∑ Recep√ß√£o{% endblock %}
{% block page_title %}Acessos{% endblock %}

{% block content %}
<div class="card" style="padding:16px">

  <!-- üîπ Filtros -->
  <form method="get" id="filtro-acessos" style="display:grid; gap:10px; margin-bottom:12px">
    <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:end">
      
      <!-- üîπ Condom√≠nio -->
      <label style="display:grid; gap:6px">
        <span>Condom√≠nio</span>
        <select name="condominio" id="condominio-select" style="min-width:220px">
          <option value="">Todos</option>
          {% for c in condominios %}
            <option value="{{ c.id }}" {% if q.condominio|default:'' == c.id|stringformat:'s' %}selected{% endif %}>
              {{ c.nome }}
            </option>
          {% endfor %}
        </select>
      </label>

      <!-- üîπ Unidade -->
      <label style="display:grid; gap:6px">
        <span>Unidade</span>
        <select name="unidade" id="unidade-select" style="min-width:160px">
          <option value="">Todas</option>
          {% for u in unidades %}
            <option value="{{ u.id }}" {% if q.unidade|default:'' == u.id|stringformat:'s' %}selected{% endif %}>
              {{ u }}
            </option>
          {% endfor %}
        </select>
      </label>

      <label style="display:grid; gap:6px">
        <span>Data inicial</span>
        <input type="date" name="dt_ini" value="{{ q.dt_ini|default:'' }}">
      </label>

      <label style="display:grid; gap:6px">
        <span>Data final</span>
        <input type="date" name="dt_fim" value="{{ q.dt_fim|default:'' }}">
      </label>

      <label style="display:grid; gap:6px">
        <span>Nome</span>
        <input type="text" name="nome" value="{{ q.nome|default:'' }}" placeholder="Nome da pessoa">
      </label>

    </div>
  </form>

  <p>
    <a class="btn" href="{% url 'acesso_create' %}">Registrar acesso</a>
    <a class="btn-outline" style="margin-left:8px" href="{% url 'dashboard' %}">Voltar</a>
  </p>

  <!-- üîπ Tabela -->
  <table border="1" cellpadding="6" width="100%" style="font-size:13px; border-collapse:collapse;">
    <thead style="background:#f8f9fa;">
      <tr>
        <th>ID</th>
        <th>Unidade</th>
        <th>Nome</th>
        <th>Telefone</th>
        <th>Tipo</th>
        <th>Data da cria√ß√£o</th>
        <th>Status</th>
        <th style="white-space:nowrap">A√ß√£o</th>
      </tr>
    </thead>
    <tbody>
      {% for a in eventos %}
      <tr>
        <td>{{ a.id }}</td>
        <td>{{ a.unidade }}</td>
        <td>{{ a.pessoa_nome }}</td>
        <td>{{ a.pessoa_telefone }}</td>
        <td>{{ a.get_pessoa_tipo_display }}</td>
        <td>{% if a.criado_em %}{{ a.criado_em|date:"d/m/Y H:i" }}{% else %}-{% endif %}</td>
        <td>{{ a.get_resultado_display }}</td>
        <td style="white-space:nowrap; text-align:center;">
          {% if a.resultado == "Requested" and perms.portaria.delete_eventoacesso %}
            <form method="post"
                  action="{% url 'acesso_delete' a.id %}"
                  style="display:inline"
                  onsubmit="return confirm('Excluir o registro de acesso de {{ a.pessoa_nome }} em {{ a.criado_em|date:"d/m/Y H:i" }}?');">
              {% csrf_token %}
              <button class="btn-outline"
                      style="border-color:#dc2626; color:#dc2626; padding:2px 8px; font-size:12px;">
                Excluir
              </button>
            </form>
          {% else %}
            ‚Äî
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="8" style="text-align:center;">Nenhum evento de acesso encontrado.</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- üîπ Pagina√ß√£o -->
  {% if eventos.has_other_pages %}
    <div style="margin-top:20px; text-align:center;">
      <div style="display:inline-flex; gap:4px;">
        {% if eventos.has_previous %}
          <a class="btn-outline" href="?page={{ eventos.previous_page_number }}{% if q.condominio %}&condominio={{ q.condominio }}{% endif %}{% if q.unidade %}&unidade={{ q.unidade }}{% endif %}{% if q.nome %}&nome={{ q.nome }}{% endif %}{% if q.dt_ini %}&dt_ini={{ q.dt_ini }}{% endif %}{% if q.dt_fim %}&dt_fim={{ q.dt_fim }}{% endif %}">Anterior</a>
        {% else %}
          <span class="btn-outline disabled">Anterior</span>
        {% endif %}

        <span class="btn muted" style="pointer-events:none;">
          P√°gina {{ eventos.number }} de {{ eventos.paginator.num_pages }}
        </span>

        {% if eventos.has_next %}
          <a class="btn-outline" href="?page={{ eventos.next_page_number }}{% if q.condominio %}&condominio={{ q.condominio }}{% endif %}{% if q.unidade %}&unidade={{ q.unidade }}{% endif %}{% if q.nome %}&nome={{ q.nome }}{% endif %}{% if q.dt_ini %}&dt_ini={{ q.dt_ini }}{% endif %}{% if q.dt_fim %}&dt_fim={{ q.dt_fim }}{% endif %}">Pr√≥xima</a>
        {% else %}
          <span class="btn-outline disabled">Pr√≥xima</span>
        {% endif %}
      </div>
    </div>
  {% endif %}
</div>

<!-- üîπ Script din√¢mico para carregar unidades -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const condSelect = document.getElementById("condominio-select");
  const unidadeSelect = document.getElementById("unidade-select");
  const btnAtualizar = document.getElementById("btn-atualizar");

  // üî∏ Atualiza lista de unidades conforme o condom√≠nio selecionado
  async function carregarUnidades(condominioId) {
    if (!condominioId) {
      unidadeSelect.innerHTML = '<option value="">Todas</option>';
      return;
    }
    try {
      const resp = await fetch(`/ajax/unidades/${condominioId}/`, { credentials: "same-origin" });
      const html = await resp.text();
      unidadeSelect.innerHTML = '<option value="">Todas</option>' + html;
    } catch (error) {
      console.error("Erro ao carregar unidades:", error);
    }
  }

  condSelect.addEventListener("change", () => carregarUnidades(condSelect.value));

  // Carrega automaticamente se houver condom√≠nio selecionado
  if (condSelect.value) carregarUnidades(condSelect.value);

      // üî∏ Bot√£o Atualizar dados (sem alert)
    btnAtualizar.addEventListener("click", async () => {
      btnAtualizar.disabled = true;
      btnAtualizar.textContent = "‚è≥ Atualizando...";

      try {
        const response = await fetch("{% url 'atualiza_acesso_salesforce' %}", {
          method: "POST",
          headers: {
            "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]')?.value || "",
          },
        });

        if (!response.ok) {
          console.error("Erro na atualiza√ß√£o de acessos:", response.statusText);
        } else {
          console.log("‚úÖ Atualiza√ß√£o conclu√≠da com sucesso!");
        }
      } catch (error) {
        console.error("‚ö†Ô∏è Erro ao atualizar dados de acessos:", error);
      } finally {
        btnAtualizar.disabled = false;
        btnAtualizar.textContent = "üîÑ Atualizar dados";
      }
    });

});
</script>
{% endblock %}
