{% extends "base.html" %}
{% load tz %}
{% block title %}Encomendas 췅 Portaria{% endblock %}
{% block page_title %}Encomendas - Recep칞칚o{% endblock %}

{% block content %}
<div class="card" style="padding:16px">
  <form method="get" id="filtro-encomendas" style="display:grid; gap:10px; margin-bottom:12px">
    <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:end">

      <!-- 游댳 Condom칤nio -->
      <label style="display:grid; gap:6px">
        <span>Condom칤nio</span>
        <select name="condominio" id="condominio-select" style="min-width:220px">
          <option value="">Todos</option>
          {% for c in condominios %}
            <option value="{{ c.id }}" {% if q.condominio|default:'' == c.id|stringformat:"s" %}selected{% endif %}>
              {{ c.nome }}
            </option>
          {% endfor %}
        </select>
      </label>

      <!-- 游댳 Unidade (din칙mica) -->
      <label style="display:grid; gap:6px">
        <span>Unidade</span>
        <select name="unidade" id="unidade-select" style="min-width:160px">
          <option value="">Todas</option>
          {% for u in unidades %}
            <option value="{{ u.id }}" {% if q.unidade|default:'' == u.id|stringformat:"s" %}selected{% endif %}>
              {{ u }}
            </option>
          {% endfor %}
        </select>
      </label>

      <!-- 游댳 Datas -->
      <label style="display:grid; gap:6px">
        <span>Data inicial</span>
        <input type="date" name="dt_ini" value="{{ q.dt_ini|default:'' }}">
      </label>

      <label style="display:grid; gap:6px">
        <span>Data final</span>
        <input type="date" name="dt_fim" value="{{ q.dt_fim|default:'' }}">
      </label>

      <!-- 游댳 Destinat치rio -->
      <label style="display:grid; gap:6px">
        <span>Destinat치rio</span>
        <input type="text" name="destinatario" value="{{ q.destinatario|default:'' }}" placeholder="Nome do destinat치rio">
      </label>

      <!-- 游댳 Status -->
      <label style="display:grid; gap:6px">
        <span>Status</span>
        <select name="status" style="min-width:160px">
          <option value="">Todos</option>
          {% for valor, label in status_choices %}
            <option value="{{ valor }}" {% if q.status == valor %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </label>

      <!-- 游댳 Bot칫es -->
      <div style="display:flex; gap:8px">
        <button class="btn" type="submit">Filtrar</button>
        <a class="btn-outline" href="{% url 'encomenda_list' %}">Limpar</a>
      </div>
    </div>
  </form>

  <p class="muted" style="margin: 6px 0 12px">
    Resultados: <strong>{{ total|default:encomendas|length }}</strong>
  </p>

  <p>
    <a class="btn" href="{% url 'encomenda_create' %}">Registrar recebimento</a>
    <a class="btn-outline" style="margin-left:8px" href="{% url 'dashboard' %}">Voltar</a>
  </p>

  <!-- 游댳 Tabela -->
  <table border="1" cellpadding="6" width="100%" style="font-size: 13px; border-collapse: collapse;">
    <thead style="background: #f8f9fa;">
      <tr>
        <th>ID</th>
        <th>Unidade</th>
        <th>Destinat치rio</th>
        <th>Recebido em</th>
        <th>Retirado em</th>
        <th>Retirado por</th>
        <th>Observa칞칫es</th>
        <th>Status</th>
        <th style="display:none;">Senha Retirada</th>
        <th style="white-space:nowrap">A칞칚o</th>
      </tr>
    </thead>
    <tbody>
      {% for e in encomendas %}
      <tr>
        <td>{{ e.id }}</td>
        <td>{{ e.unidade }}</td>
        <td>{{ e.destinatario }}</td>
        <td>{{ e.data_recebimento|localtime|date:"d/m/Y H:i" }}</td>
        <td>{{ e.data_entrega|localtime|date:"d/m/Y H:i" }}</td>
        <td>{{ e.RetiradoPor }}</td>
        <td>{{ e.observacoes }}</td>
        <td>{{ e.get_status_display }}</td>
        <td style="display:none;">{{ e.SenhaRetirada }}</td>
        <td style="white-space:nowrap">
          {% if perms.portaria.pode_entregar_encomenda and e.status == 'RECEBIDA' %}
            <form method="post" action="{% url 'encomenda_entregar' e.id %}" style="display:inline" class="entrega-form">
              {% csrf_token %}
              <input type="hidden" name="senha_correta" value="{{ e.SenhaRetirada|default:'' }}">
              <input type="hidden" name="retirado_por" value="">
              <button type="button" class="btn-outline btn-entregar" style="font-size:12px;">Entregar</button>
            </form>
          {% endif %}
          {% if e.status != "ENTREGUE" %}
            <form action="{% url 'encomenda_delete' e.id %}" method="post" style="display:inline;">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger btn-sm" style="font-size:12px;"
                      onclick="return confirm('Tem certeza que deseja excluir esta encomenda?');">
                Excluir
              </button>
            </form>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="9">Nenhuma encomenda encontrada para o filtro aplicado.</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- 游댳 Pagina칞칚o -->
  {% if encomendas.has_other_pages %}
  <div style="margin-top:20px; text-align:center;">
    <div style="display:inline-flex; gap:4px;">
      {% if encomendas.has_previous %}
        <a class="btn-outline" href="?page={{ encomendas.previous_page_number }}{% if q.condominio %}&condominio={{ q.condominio }}{% endif %}{% if q.unidade %}&unidade={{ q.unidade }}{% endif %}{% if q.destinatario %}&destinatario={{ q.destinatario }}{% endif %}{% if q.status %}&status={{ q.status }}{% endif %}{% if q.dt_ini %}&dt_ini={{ q.dt_ini }}{% endif %}{% if q.dt_fim %}&dt_fim={{ q.dt_fim }}{% endif %}">Anterior</a>
      {% else %}
        <span class="btn-outline disabled">Anterior</span>
      {% endif %}

      <span class="btn muted" style="pointer-events:none;">
        P치gina {{ encomendas.number }} de {{ encomendas.paginator.num_pages }}
      </span>

      {% if encomendas.has_next %}
        <a class="btn-outline" href="?page={{ encomendas.next_page_number }}{% if q.condominio %}&condominio={{ q.condominio }}{% endif %}{% if q.unidade %}&unidade={{ q.unidade }}{% endif %}{% if q.destinatario %}&destinatario={{ q.destinatario }}{% endif %}{% if q.status %}&status={{ q.status }}{% endif %}{% if q.dt_ini %}&dt_ini={{ q.dt_ini }}{% endif %}{% if q.dt_fim %}&dt_fim={{ q.dt_fim }}{% endif %}">Pr칩xima</a>
      {% else %}
        <span class="btn-outline disabled">Pr칩xima</span>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <!-- 游댳 Popup de confirma칞칚o de entrega -->
  <div id="senha-popup" style="
    display:none;
    position:fixed;
    top:0; left:0; right:0; bottom:0;
    background:rgba(0,0,0,0.6);
    align-items:center;
    justify-content:center;
    z-index:9999;">
    <div style="
      background:white;
      padding:20px;
      border-radius:8px;
      width:320px;
      text-align:center;">
      <h3>Confirme a Retirada</h3>
      <input type="password" id="senha-input" class="form-control"
            placeholder="Digite a senha" style="margin:10px 0; width:100%;">
      <input type="text" id="retirado-input" class="form-control"
            placeholder="Retirado por" style="margin:10px 0; width:100%;">
      <div style="display:flex; justify-content:space-between;">
        <button id="senha-cancelar" class="btn-outline">Cancelar</button>
        <button id="senha-confirmar" class="btn">Confirmar</button>
      </div>
    </div>
  </div>


</div>

<!-- 游댳 Script do popup -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const popup = document.getElementById("senha-popup");
  const senhaInput = document.getElementById("senha-input");
  const retiradoInput = document.getElementById("retirado-input");
  const btnConfirmar = document.getElementById("senha-confirmar");
  const btnCancelar = document.getElementById("senha-cancelar");
  let currentForm = null;
  let senhaCorreta = "";

  // Popup entrega
  document.querySelectorAll(".btn-entregar").forEach(btn => {
    btn.addEventListener("click", (e) => {
      const form = e.target.closest(".entrega-form");
      senhaCorreta = form.querySelector("input[name='senha_correta']").value || "";
      currentForm = form;
      senhaInput.value = "";
      retiradoInput.value = "";
      popup.style.display = "flex";
      senhaInput.focus();
    });
  });

  btnCancelar.addEventListener("click", () => {
    popup.style.display = "none";
    currentForm = null;
  });

  btnConfirmar.addEventListener("click", () => {
    if (!currentForm) return;
    const senhaDigitada = senhaInput.value.trim();
    const retiradoPor = retiradoInput.value.trim();
    if (!retiradoPor) {
      alert("Por favor, informe quem retirou a encomenda.");
      retiradoInput.focus();
      return;
    }
    if (senhaCorreta && senhaDigitada !== senhaCorreta.trim()) {
      alert("Senha incorreta. Tente novamente.");
      senhaInput.value = "";
      senhaInput.focus();
      return;
    }
    currentForm.querySelector("input[name='retirado_por']").value = retiradoPor;
    popup.style.display = "none";
    currentForm.submit();
  });
});
</script>

<!-- 游댳 Script din칙mico para Unidades -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const condSelect = document.getElementById("condominio-select");
  const unidadeSelect = document.getElementById("unidade-select");

  async function carregarUnidades(condominioId) {
    if (!condominioId) {
      unidadeSelect.innerHTML = '<option value="">Todas</option>';
      return;
    }
    try {
      const resp = await fetch(`/ajax/unidades/${condominioId}/`, { credentials: "same-origin" });
      const html = await resp.text();
      unidadeSelect.innerHTML = '<option value="">Todas</option>' + html;
    } catch (error) {
      console.error("Erro ao carregar unidades:", error);
    }
  }

  condSelect.addEventListener("change", () => {
    const condId = condSelect.value;
    carregarUnidades(condId);
  });

  // Carrega unidades automaticamente se j치 houver um condom칤nio selecionado
  if (condSelect.value) {
    carregarUnidades(condSelect.value);
  }
});
</script>
{% endblock %}
