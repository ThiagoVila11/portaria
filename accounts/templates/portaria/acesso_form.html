{% extends "base.html" %}
{% block title %}Novo Acesso Â· Portaria{% endblock %}
{% block page_title %}Novo Acesso{% endblock %}

{% block content %}
<div class="card" style="padding:16px">
  <form id="acesso-form" method="post" style="display:grid; gap:12px">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="msg error">{{ form.non_field_errors }}</div>
    {% endif %}

    <div style="display:grid; gap:10px; grid-template-columns: repeat(2, minmax(220px, 1fr));">
      <label style="display:grid; gap:6px">
        <span>CondomÃ­nio</span>
        {{ form.condominio }}
        {{ form.condominio.errors }}
      </label>

      <label style="display:grid; gap:6px">
        <span>Unidade</span>
        {{ form.unidade }}
        {{ form.unidade.errors }}
      </label>

      <label style="display:grid; gap:6px">
        <span>ResponsÃ¡vel</span>
        {{ form.responsavel }}
        {{ form.responsavel.errors }}
      </label>

      <label style="display:grid; gap:6px">
        <span>Nome</span>
        {{ form.pessoa_nome }}
        {{ form.pessoa_nome.errors }}
      </label>

      <label style="display:grid; gap:6px">
        <span>Tipo</span>
        {{ form.pessoa_tipo }}
        {{ form.pessoa_tipo.errors }}
      </label>

      <label style="display:grid; gap:6px">
        <span>Telefone</span>
        {{ form.pessoa_telefone }}
        {{ form.pessoa_telefone.errors }}
      </label>

      <label style="display:grid; gap:6px">
        <span>Status</span>
        {{ form.resultado }}
        {{ form.resultado.errors }}
      </label>
    </div>

    <!-- ðŸ”¹ BotÃµes alinhados -->
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px;">
      <button id="btn-salvar" class="btn" type="submit">Salvar</button>
      <a class="btn-outline" href="{% url 'acesso_list' %}">Cancelar</a>
    </div>

  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const $cond = document.querySelector('select[name="condominio"]');
  const $uni  = document.querySelector('select[name="unidade"]');
  const $resp = document.querySelector('select[name="responsavel"]');

  async function carregarUnidades(condId){
    if(!condId){
      $uni.innerHTML = '<option value="">â€”</option>';
      $resp.innerHTML = '<option value="">â€”</option>';
      return;
    }
    const resp = await fetch(`/ajax/unidades/${condId}/`, {credentials: 'same-origin'});
    $uni.innerHTML = await resp.text();
    $resp.innerHTML = '<option value="">â€”</option>';
  }

  async function carregarResponsaveis(uniId){
    if(!uniId){
      $resp.innerHTML = '<option value="">â€”</option>';
      return;
    }
    const resp = await fetch(`/ajax/responsaveis/${uniId}/`, {credentials: 'same-origin'});
    $resp.innerHTML = await resp.text();
  }

  if($cond){
    $cond.addEventListener('change', ()=> carregarUnidades($cond.value));
  }

  if($uni){
    $uni.addEventListener('change', ()=> carregarResponsaveis($uni.value));
  }

  if($cond && $cond.value){
    carregarUnidades($cond.value);
  }
  if($uni && $uni.value){
    carregarResponsaveis($uni.value);
  }
})();

// ðŸ”¹ Evita mÃºltiplos envios do formulÃ¡rio
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("acesso-form");
  const btnSalvar = document.getElementById("btn-salvar");

  form.addEventListener("submit", () => {
    btnSalvar.disabled = true;
    btnSalvar.textContent = "Salvando...";
    btnSalvar.style.opacity = "0.7";
    btnSalvar.style.cursor = "not-allowed";
  });
});
</script>
{% endblock %}
