{% extends "base.html" %}

{% block title %}{{ obj|default:"Nova Encomenda" }} Â· Portaria{% endblock %}
{% block page_title %}{{ obj|default:"Nova Encomenda" }}{% endblock %}

{% block content %}
<div class="card" style="padding:16px">
  <form id="encomenda-form" method="post" enctype="multipart/form-data" style="display:grid; gap:12px">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="msg error">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    <div style="display:grid; gap:10px; grid-template-columns: repeat(2, minmax(220px, 1fr));">

      <label style="display:grid; gap:6px">
        <span>CondomÃ­nio</span>
        {{ form.condominio }}
        {{ form.condominio.errors }}
      </label>

      <label style="display:grid; gap:6px">
        <span>Unidade</span>
        {{ form.unidade }}
        {{ form.unidade.errors }}
      </label>

      <label style="display:grid; gap:6px; grid-column: 1 / -1;">
        <span>DestinatÃ¡rio</span>
        {{ form.destinatario }}
        {{ form.destinatario.errors }}
      </label>

      <label style="display:grid; gap:6px; grid-column: 1 / -1;">
        <span>Tipo</span>
        {{ form.PackageName }}
        {{ form.PackageName.errors }}
      </label>

      <label style="display:grid; gap:6px; grid-column: 1 / -1;">
        <span>ObservaÃ§Ãµes</span>
        {{ form.observacoes }}
        {{ form.observacoes.errors }}
      </label>

      {% if form.etiqueta_imagem %}
      <input type="hidden" name="etiqueta_imagem" value="">
      {% endif %}

      <input type="hidden" name="status" value="RECEBIDA">

      <hr style="margin:12px 0;">

<hr style="margin:12px 0;">
<h4>Foto da Encomenda</h4>

      <div style="display:flex; gap:8px; align-items:center;">
        <button type="button" class="btn-outline" id="btn-abrir-camera">
          ðŸ“· Tirar Foto
        </button>
      </div>

      <!-- Modal simples -->
      <div id="camera-modal" style="
        display:none;
        position:fixed;
        inset:0;
        background:rgba(0,0,0,0.6);
        justify-content:center;
        align-items:center;
        z-index:9999;
      ">
        <div style="background:#fff; padding:16px; border-radius:8px; max-width:420px; width:100%;">
          <video id="camera-video" autoplay playsinline style="width:100%; border-radius:6px;"></video>
          <canvas id="camera-canvas" style="display:none;"></canvas>

          <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
            <button type="button" class="btn-outline" id="btn-cancelar-camera">Cancelar</button>
            <button type="button" class="btn" id="btn-capturar-foto">Capturar</button>
          </div>
        </div>
      </div>


      <h4>Anexos (mÃ¡ximo 5)</h4>

      <div id="file-inputs" style="display:grid; gap:10px;">
        <input type="file" name="arquivo_01" id="arquivo_01" accept="application/pdf,image/*">
        <input type="file" name="arquivo_02" id="arquivo_02" style="display:none;" accept="application/pdf,image/*">
        <input type="file" name="arquivo_03" id="arquivo_03" style="display:none;" accept="application/pdf,image/*">
        <input type="file" name="arquivo_04" id="arquivo_04" style="display:none;" accept="application/pdf,image/*">
        <input type="file" name="arquivo_05" id="arquivo_05" style="display:none;" accept="application/pdf,image/*">
      </div>

    </div>

    <!-- ðŸ”¹ BotÃµes alinhados -->
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px;">
      <button id="btn-salvar" class="btn" type="submit">Salvar Encomenda</button>
      <a class="btn-outline" href="{% url 'encomenda_list' %}">Cancelar</a>
    </div>

  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const $cond = document.querySelector('select[name="condominio"]');
  const $uni  = document.querySelector('select[name="unidade"]');
  const $dest = document.querySelector('select[name="destinatario"]');

  async function carregarUnidades(condId){
    if(!condId){
      $uni.innerHTML = '<option value="">â€”</option>';
      $dest.innerHTML = '<option value="">â€”</option>';
      return;
    }
    const resp = await fetch(`/ajax/unidades/${condId}/`, {credentials: 'same-origin'});
    $uni.innerHTML = await resp.text();
    $dest.innerHTML = '<option value="">â€”</option>';
  }

  async function carregarMoradores(uniId){
    if(!uniId){
      $dest.innerHTML = '<option value="">â€”</option>';
      return;
    }
    const resp = await fetch(`/ajax/moradores/${uniId}/`, {credentials: 'same-origin'});
    $dest.innerHTML = await resp.text();
  }

  if($cond){
    $cond.addEventListener('change', function(){
      carregarUnidades(this.value);
    });
  }

  if($uni){
    $uni.addEventListener('change', function(){
      carregarMoradores(this.value);
    });
  }

  if($cond && $cond.value){
    carregarUnidades($cond.value);
  }
  if($uni && $uni.value){
    carregarMoradores($uni.value);
  }
})();

  // ðŸ”¹ Exibe dinamicamente os inputs de arquivos
  document.addEventListener("DOMContentLoaded", () => {
    for (let i = 1; i <= 5; i++) {
      const input = document.getElementById(`arquivo_0${i}`);
      input?.addEventListener("change", () => {
        if (input.files.length > 0 && i < 5) {
          const next = document.getElementById(`arquivo_0${i + 1}`);
          if (next) next.style.display = "block";
        }
      });
    }

    // ðŸ”¹ Evita mÃºltiplos envios do formulÃ¡rio
    const form = document.getElementById("encomenda-form");
    const btnSalvar = document.getElementById("btn-salvar");

    form.addEventListener("submit", () => {
      btnSalvar.disabled = true;
      btnSalvar.textContent = "Salvando...";
      btnSalvar.style.opacity = "0.7";
      btnSalvar.style.cursor = "not-allowed";
    });
  });


  /* ðŸ“· Captura de foto via webcam / cÃ¢mera do celular */
  (function () {
    const btnAbrir = document.getElementById("btn-abrir-camera");
    const modal = document.getElementById("camera-modal");
    const video = document.getElementById("camera-video");
    const canvas = document.getElementById("camera-canvas");
    const btnCapturar = document.getElementById("btn-capturar-foto");
    const btnCancelar = document.getElementById("btn-cancelar-camera");

    let stream = null;

    function getNextFileInput() {
      for (let i = 1; i <= 5; i++) {
        const input = document.getElementById(`arquivo_0${i}`);
        if (input && input.files.length === 0) {
          return input;
        }
      }
      alert("Limite mÃ¡ximo de 5 anexos atingido.");
      return null;
    }

    async function abrirCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
          audio: false
        });
        video.srcObject = stream;
        modal.style.display = "flex";
      } catch (err) {
        alert("NÃ£o foi possÃ­vel acessar a cÃ¢mera.");
        console.error(err);
      }
    }

    function fecharCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      modal.style.display = "none";
    }

    btnAbrir?.addEventListener("click", abrirCamera);
    btnCancelar?.addEventListener("click", fecharCamera);

    btnCapturar?.addEventListener("click", () => {
      const input = getNextFileInput();
      if (!input) return;

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0);

      canvas.toBlob(blob => {
        const file = new File(
          [blob],
          `foto_encomenda_${Date.now()}.jpg`,
          { type: "image/jpeg" }
        );

        const dt = new DataTransfer();
        dt.items.add(file);
        input.files = dt.files;

        input.style.display = "block";
        input.dispatchEvent(new Event("change"));

        fecharCamera();
      }, "image/jpeg", 0.9);
    });
  })();

</script>
{% endblock %}
