{% extends "base.html" %}

{% block title %}{{ obj|default:"Nova Encomenda" }} · Portaria{% endblock %}
{% block page_title %}{{ obj|default:"Nova Encomenda" }}{% endblock %}

{% block content %}
<div class="card" style="padding:16px">
  <form method="post" enctype="multipart/form-data" style="display:grid; gap:12px">
    {% csrf_token %}

    <!-- Erros gerais -->
    {% if form.non_field_errors %}
      <div class="msg error">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    <!-- Campos (render explícito, bonito e com erros por campo) -->
    <div style="display:grid; gap:10px; grid-template-columns: repeat(2, minmax(220px, 1fr));">

      <label style="display:grid; gap:6px">
        <span>Condomínio</span>
        {{ form.condominio}}
        {{ form.condominio.errors }}
      </label>

      <label style="display:grid; gap:6px">
        <span>Unidade</span>
        {{ form.unidade}}
        {{ form.unidade.errors }}
      </label>

      <label style="display:grid; gap:6px; grid-column: 1 / -1;">
        <span>Destinatário</span>
        {{ form.destinatario }}
        {{ form.destinatario.errors }}
      </label>

      <label style="display:grid; gap:6px; grid-column: 1 / -1;">
        <span>Tipo </span>
        {{ form.PackageName }}
        {{ form.PackageName.errors }}
      </label>

      <label style="display:grid; gap:6px; grid-column: 1 / -1;">
        <span>Observações</span>
        {{ form.observacoes }}
        {{ form.observacoes.errors }}
      </label>

      {% if form.etiqueta_imagem %}
      <input type="hidden" name="etiqueta_imagem" value="">
      {% endif %}

      <input type="hidden" name="status" value="RECEBIDA">
    </div>

    <div style="display:flex; gap:8px; margin-top:8px">
      <button class="btn" type="submit">Salvar</button>
      <a class="btn-outline" href="{% url 'encomenda_list' %}">Cancelar</a>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const $cond = document.querySelector('select[name="condominio"]');
  const $uni  = document.querySelector('select[name="unidade"]');
  const $dest = document.querySelector('select[name="destinatario"]');

  async function carregarUnidades(condId){
    if(!condId){
      $uni.innerHTML = '<option value="">—</option>';
      $dest.innerHTML = '<option value="">—</option>';
      return;
    }
    const resp = await fetch(`/ajax/unidades/${condId}/`, {credentials: 'same-origin'});
    $uni.innerHTML = await resp.text();
    $dest.innerHTML = '<option value="">—</option>'; // limpa destinatário
  }

  async function carregarMoradores(uniId){
    if(!uniId){
      $dest.innerHTML = '<option value="">—</option>';
      return;
    }
    const resp = await fetch(`/ajax/moradores/${uniId}/`, {credentials: 'same-origin'});
    $dest.innerHTML = await resp.text();
  }

  if($cond){
    $cond.addEventListener('change', function(){
      carregarUnidades(this.value);
    });
  }

  if($uni){
    $uni.addEventListener('change', function(){
      carregarMoradores(this.value);
    });
  }

  // se já houver valores selecionados (edição ou POST inválido), carrega automaticamente
  if($cond && $cond.value){
    carregarUnidades($cond.value);
  }
  if($uni && $uni.value){
    carregarMoradores($uni.value);
  }
})();
</script>
{% endblock %}