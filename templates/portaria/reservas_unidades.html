{% extends "base.html" %}
{% load timezone_filters %}
{% block title %}Reservas 췅 Portaria{% endblock %}
{% block page_title %}Reservas - Recep칞칚o{% endblock %}

{% block content %}
{% now "Y-m-d" as today %}

<div class="card" style="padding:16px; overflow-x:auto;">

  <!-- 游댳 Filtros -->
  <form method="get" id="filtro-reservas" style="display:flex; gap:10px; margin-bottom:12px; flex-wrap: wrap;">
    <label style="display:grid; gap:6px">
      <span>Condom칤nio</span>
      <select name="condominio" id="condominio-select" style="min-width:220px;">
        <option value="">Todos</option>
        {% for c in condominios %}
          <option value="{{ c.id }}" {% if condominio_pk == c.id|stringformat:"s" %}selected{% endif %}>
            {{ c.nome }}
          </option>
        {% endfor %}
      </select>
    </label>

    <!-- 游댳 Unidade (carregamento din칙mico) -->
    <label style="display:grid; gap:6px">
      <span>Unidade</span>
      <select name="unidade" id="unidade-select" style="min-width:180px;">
        <option value="">Todas</option>
        {% for u in unidades %}
          <option value="{{ u.id }}" {% if unidade_pk == u.id|stringformat:"s" %}selected{% endif %}>
            {{ u }}
          </option>
        {% endfor %}
      </select>
    </label>

    <label style="display:grid; gap:6px">
      <span>Data in칤cio</span>
      <input type="date" name="data_inicio" value="{{ data_inicio|default:today|default:'' }}">
    </label>

    <label style="display:grid; gap:6px">
      <span>Data fim</span>
      <input type="date" name="data_fim" value="{{ data_fim|default:'' }}">
    </label>

    <div style="align-self:end">
      <button class="btn" type="submit">Filtrar</button>
      <a class="btn-outline" href="{% url 'reservas_unidades' %}">Limpar</a>
    </div>
  </form>

  <!-- 游댳 Total -->
  <p class="muted">Total: <strong>{{ total }}</strong></p>

  <!-- 游댳 Tabela -->
  <div style="overflow-x:auto;">
    <table border="1" cellpadding="6" width="100%" style="border-collapse: collapse; min-width: 1000px;">
      <thead style="background:#f8f9fa;">
        <tr>
          <th>ID</th>
          <th>Espa칞o</th>
          <th>Unidade</th>
          <th>Respons치vel</th>
          <th>Descri칞칚o</th>
          <th>Data In칤cio</th>
          <th>Data Fim</th>
          <th>Valor</th>
          <th>Situa칞칚o</th>
        </tr>
      </thead>
      <tbody>
        {% for v in reservas %}
        <tr>
          <td>{{ v.Id }}</td>
          <td>{{ v.reda__Property__r.Name }}</td>
          <td>{{ v.Opportunity_property__c }}</td>
          <td>{{ v.Contact__r.Name }}</td>
          <td>{{ v.reda__Description__c }}</td>
          <td>{{ v.reda__Start_Datetime__c|local_sp }}</td>
          <td>{{ v.reda__End_Datetime__c|local_sp }}</td>
          <td>{{ v.reda__Total_Booking_Amount__c }}</td>
          <td>{{ v.Status_PT }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="9" style="text-align:center;">Nenhuma reserva encontrada.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- 游댳 Pagina칞칚o -->
  {% if reservas.has_other_pages %}
  <div style="margin-top:20px; text-align:center;">
    <div style="display:inline-flex; gap:6px;">
      {% if reservas.has_previous %}
        <a class="btn-outline"
           href="?page={{ reservas.previous_page_number }}{% if condominio_pk %}&condominio={{ condominio_pk }}{% endif %}{% if unidade_pk %}&unidade={{ unidade_pk }}{% endif %}{% if data_inicio %}&data_inicio={{ data_inicio }}{% endif %}{% if data_fim %}&data_fim={{ data_fim }}{% endif %}">
           Anterior
        </a>
      {% else %}
        <span class="btn-outline disabled">Anterior</span>
      {% endif %}

      <span class="btn muted" style="pointer-events:none;">
        P치gina {{ reservas.number }} de {{ reservas.paginator.num_pages }}
      </span>

      {% if reservas.has_next %}
        <a class="btn-outline"
           href="?page={{ reservas.next_page_number }}{% if condominio_pk %}&condominio={{ condominio_pk }}{% endif %}{% if unidade_pk %}&unidade={{ unidade_pk }}{% endif %}{% if data_inicio %}&data_inicio={{ data_inicio }}{% endif %}{% if data_fim %}&data_fim={{ data_fim }}{% endif %}">
           Pr칩xima
        </a>
      {% else %}
        <span class="btn-outline disabled">Pr칩xima</span>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>

<!-- 游댳 Script din칙mico para carregar Unidades -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const condSelect = document.getElementById("condominio-select");
  const unidadeSelect = document.getElementById("unidade-select");

  async function carregarUnidades(condominioId) {
    if (!condominioId) {
      unidadeSelect.innerHTML = '<option value="">Todas</option>';
      return;
    }
    try {
      const resp = await fetch(`/ajax/unidades/${condominioId}/`, { credentials: "same-origin" });
      const html = await resp.text();
      unidadeSelect.innerHTML = '<option value="">Todas</option>' + html;
    } catch (error) {
      console.error("Erro ao carregar unidades:", error);
    }
  }

  condSelect.addEventListener("change", () => {
    const condId = condSelect.value;
    carregarUnidades(condId);
  });

  // Carrega automaticamente se j치 houver condom칤nio selecionado
  if (condSelect.value) {
    carregarUnidades(condSelect.value);
  }
});
</script>

{% endblock %}
